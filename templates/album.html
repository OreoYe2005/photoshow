<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ album_name }} | OREO</title>
    <script src="https://cdn.staticfile.org/tailwindcss/3.4.1/script.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { lightBg: '#f8fafc' } } }
        }
    </script>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark'); localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark'); localStorage.theme = 'dark';
            }
        }
    </script>
</head>
<body class="bg-lightBg text-neutral-900 dark:bg-neutral-900 dark:text-white min-h-screen transition-colors duration-300">

    <button onclick="toggleTheme()" class="fixed top-20 right-6 z-50 p-2.5 rounded-full bg-white/80 dark:bg-neutral-800/80 shadow-lg hover:scale-110 transition-transform backdrop-blur-md border border-neutral-200 dark:border-neutral-700 text-neutral-800 dark:text-yellow-400">
        <svg class="w-5 h-5 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
    </button>

    <nav class="fixed top-0 w-full bg-white/80 dark:bg-neutral-900/80 backdrop-blur-md z-40 border-b border-neutral-200 dark:border-neutral-800 p-4 transition-colors duration-300">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="/" class="text-sm font-bold hover:text-green-600 dark:hover:text-green-400 transition-colors flex items-center gap-2">â† è¿”å›é¦–é¡µ</a>
            <span class="text-lg font-bold">{{ album_name }}</span>
            <div id="navUserArea" class="text-xs"></div>
        </div>
    </nav>

    <header class="pt-32 pb-10 px-4 text-center max-w-2xl mx-auto">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 tracking-tight">{{ album_name }}</h1>
        <p class="text-neutral-500 dark:text-neutral-400 text-lg leading-relaxed">{{ album_desc }}</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 pb-20">
        {% if grouped_photos|length == 0 %}
            <div class="text-center text-neutral-400 dark:text-neutral-600 mt-20">è¿™é‡Œè¿˜æ²¡æœ‰ç…§ç‰‡å“¦</div>
        {% else %}
            {% for group in grouped_photos %}
                <div class="mt-12 mb-6 border-b border-neutral-200 dark:border-neutral-800 pb-2">
                    <h2 class="text-xl font-bold text-green-600 dark:text-green-400 flex items-center gap-2">
                        ğŸ“… {{ group.date }}
                        <span class="text-xs text-neutral-400 dark:text-neutral-500 font-normal">({{ group.photos|length }} å¼ )</span>
                    </h2>
                </div>

                <div class="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6 mb-12">
                    {% for photo in group.photos %}
                    <div class="break-inside-avoid bg-white dark:bg-neutral-800 rounded-xl overflow-hidden shadow-md dark:shadow-xl hover:shadow-lg transition-shadow duration-300 relative group">
                        
                        <img src="{{ photo.src }}" loading="lazy" class="w-full h-auto object-cover hover:opacity-95 transition-opacity">
                        
                        <button onclick="deletePhoto('{{ photo.id }}')" class="admin-only hidden absolute top-2 right-2 bg-red-600 text-white p-1.5 rounded-full shadow-lg hover:bg-red-500 z-20">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>

                        <div class="p-3 flex justify-between items-start">
                            <div class="flex-1">
                                {% if photo.description %}
                                <p class="text-neutral-600 dark:text-neutral-300 text-sm leading-relaxed">{{ photo.description }}</p>
                                {% endif %}
                            </div>
                            
                            <button onclick="toggleLike('{{ photo.id }}', this)" class="flex items-center gap-1 text-neutral-400 hover:text-red-500 transition-colors ml-2 group-like">
                                <svg class="w-5 h-5 heart-icon transition-transform active:scale-125" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                                <span class="text-xs font-mono like-count">{{ photo.likes }}</span>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% endif %}
    </main>

    <script src="https://cdn.staticfile.org/supabase-js/2.39.3/supabase.min.js"></script>
    <script>
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // ğŸŸ¢ è¯·ä¿®æ”¹ä¸ºä½ çš„ç®¡ç†å‘˜é‚®ç®±
        const ADMIN_EMAIL = "admin@oreo.com"; 
        let currentUser = null;

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            
            // é¡¶éƒ¨ç®€å•æ˜¾ç¤ºç”¨æˆ·çŠ¶æ€
            const navUser = document.getElementById('navUserArea');
            if(user) navUser.innerText = user.email.split('@')[0];

            if (user && user.email === ADMIN_EMAIL) {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            }
        }

        async function toggleLike(photoId, btn) {
            if (!currentUser) {
                alert("è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµå“¦ï¼");
                window.location.href = "/login";
                return;
            }

            const icon = btn.querySelector('.heart-icon');
            const countSpan = btn.querySelector('.like-count');
            let currentCount = parseInt(countSpan.innerText);

            // ç®€å•å‰ç«¯åé¦ˆï¼Œå®é™…åº”æŸ¥è¯¢æ•°æ®åº“çŠ¶æ€
            // è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ï¼šå…ˆå‡è®¾æœªç‚¹èµ -> ç‚¹èµ
            const { error } = await supabase.from('likes').insert({ user_id: currentUser.id, photo_id: photoId });
            
            if (error) {
                // å¦‚æœæ’å…¥å¤±è´¥(é€šå¸¸æ˜¯å› ä¸ºå·²ç»ç‚¹è¿‡èµäº†ï¼Œè¿åå”¯ä¸€çº¦æŸ)ï¼Œåˆ™æ‰§è¡Œåˆ é™¤(å–æ¶ˆç‚¹èµ)
                // æ³¨æ„ï¼šè¿™éœ€è¦ä½ åœ¨ likes è¡¨è®¾ç½® unique(user_id, photo_id) çº¦æŸ
                // å¦‚æœæ²¡æœ‰çº¦æŸï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•ç”¨ confirm æ¨¡æ‹Ÿå–æ¶ˆç‚¹èµæŸ¥è¯¢
                
                // æ›´ä¸¥è°¨çš„å†™æ³•æ˜¯å…ˆ select maybeSingleï¼Œä½†ä¸ºäº†ä»£ç ç®€æ´ï¼š
                const { data: exist } = await supabase.from('likes').select('id').match({user_id: currentUser.id, photo_id: photoId}).maybeSingle();
                if(exist) {
                     await supabase.from('likes').delete().eq('id', exist.id);
                     icon.classList.remove('fill-red-500', 'text-red-500');
                     countSpan.innerText = Math.max(0, currentCount - 1);
                }
            } else {
                icon.classList.add('fill-red-500', 'text-red-500');
                countSpan.innerText = currentCount + 1;
            }
        }

        async function deletePhoto(photoId) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ“ä½œæ— æ³•æ’¤é”€ã€‚")) return;
            const { error } = await supabase.from('photos').delete().eq('id', photoId);
            if (error) alert("åˆ é™¤å¤±è´¥: " + error.message);
            else { alert("å·²åˆ é™¤"); window.location.reload(); }
        }

        init();
    </script>
</body>
</html>