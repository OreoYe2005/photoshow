<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ ä½œå“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        lightBg: '#f8fafc', 
                    }
                }
            }
        }
    </script>

    <script>
        // è‡ªåŠ¨è¯»å–æœ¬åœ°å­˜å‚¨çš„ä¸»é¢˜è®¾ç½®
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>
</head>
<body class="bg-lightBg text-neutral-900 dark:bg-neutral-900 dark:text-white flex items-center justify-center min-h-screen transition-colors duration-300">

    <button onclick="toggleTheme()" class="fixed top-6 right-6 z-50 p-3 rounded-full bg-white/80 dark:bg-neutral-800/80 shadow-lg hover:scale-110 transition-transform backdrop-blur-md border border-neutral-200 dark:border-neutral-700 text-neutral-800 dark:text-yellow-400">
        <svg class="w-6 h-6 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
        <svg class="w-6 h-6 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
    </button>

    <div class="bg-white dark:bg-neutral-800 p-8 rounded-xl shadow-xl w-full max-w-md transition-colors duration-300 border border-neutral-100 dark:border-neutral-700">
        <h1 class="text-2xl font-bold mb-6 text-center text-green-600 dark:text-green-400">ä¸Šä¼ æ–°ä½œå“</h1>
        
        <form id="uploadForm" class="space-y-4">
            <div>
                <label class="block mb-2 text-sm text-neutral-600 dark:text-neutral-400">é€‰æ‹©ç…§ç‰‡</label>
                <input type="file" id="fileInput" accept="image/*" multiple required
                    class="block w-full text-sm text-neutral-700 dark:text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-500 cursor-pointer">
            </div>

            <div class="p-4 bg-neutral-50 dark:bg-neutral-700/50 rounded-lg border border-neutral-200 dark:border-neutral-600 transition-colors">
                <p class="text-xs text-green-600 dark:text-green-400 mb-3 font-bold uppercase tracking-wider">ğŸ“‚ ç›¸ç°¿è®¾ç½®</p>
                
                <div class="mb-3">
                    <label class="block mb-1 text-xs text-neutral-500 dark:text-neutral-400">ç›¸ç°¿åç§°</label>
                    <input type="text" id="albumInput" placeholder="ä¾‹å¦‚ï¼šé£å…‰" required
                        class="w-full px-3 py-2 bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 rounded text-sm text-neutral-900 dark:text-white focus:outline-none focus:border-green-500 transition-colors">
                </div>
                
                <div>
                    <label class="block mb-1 text-xs text-neutral-500 dark:text-neutral-400">ç›¸ç°¿ç®€ä»‹ (æ–°å»ºæ—¶å¡«å†™)</label>
                    <textarea id="albumDescInput" rows="2" placeholder="è¿™ä¸ªç›¸ç°¿æ˜¯å…³äº..." 
                        class="w-full px-3 py-2 bg-white dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-600 rounded text-sm text-neutral-900 dark:text-white focus:outline-none focus:border-green-500 transition-colors"></textarea>
                </div>
            </div>
            
            <div>
                <label class="block mb-2 text-sm text-neutral-600 dark:text-neutral-400">ç…§ç‰‡æè¿° (æ¯å¼ ç…§ç‰‡é€šç”¨)</label>
                <textarea id="descInput" rows="2" placeholder="æ‹æ‘„äº..." 
                    class="w-full px-4 py-2 bg-neutral-50 dark:bg-neutral-700 border border-neutral-300 dark:border-neutral-600 rounded text-neutral-900 dark:text-white focus:outline-none focus:border-green-500 transition-colors"></textarea>
            </div>

            <div>
                <label class="block mb-2 text-sm text-neutral-600 dark:text-neutral-400">ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="passwordInput" required
                    class="w-full px-4 py-2 bg-neutral-50 dark:bg-neutral-700 border border-neutral-300 dark:border-neutral-600 rounded text-neutral-900 dark:text-white focus:outline-none focus:border-green-500 transition-colors">
            </div>

            <div id="statusArea" class="hidden">
                <div class="w-full bg-neutral-200 dark:bg-neutral-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="statusText" class="text-xs text-center mt-2 text-neutral-500 dark:text-neutral-400">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-lg transition-all hover:scale-[1.02]">
                å¼€å§‹ä¸Šä¼  ğŸš€
            </button>
        </form>
        
        <div class="mt-4 text-center">
             <a href="/" class="text-neutral-500 hover:text-green-600 dark:hover:text-white transition-colors text-sm">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('uploadForm');

        function getTakenDate(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                    if (exifDate) {
                        const str = exifDate.split(" ")[0].replace(/:/g, "-") + " " + exifDate.split(" ")[1];
                        resolve(str);
                    } else {
                        resolve(new Date().toISOString()); 
                    }
                });
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            if (password !== "oreo2025") { alert("å¯†ç é”™è¯¯ï¼"); return; }

            const files = document.getElementById('fileInput').files;
            const albumName = document.getElementById('albumInput').value || "æœªåˆ†ç±»";
            const albumDesc = document.getElementById('albumDescInput').value;
            const photoDesc = document.getElementById('descInput').value || "";

            if (files.length === 0) return;

            const submitBtn = document.getElementById('submitBtn');
            const statusArea = document.getElementById('statusArea');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');

            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            statusArea.classList.remove('hidden');

            try {
                if (albumDesc) {
                    statusText.innerText = `æ­£åœ¨æ›´æ–°ç›¸ç°¿ä¿¡æ¯...`;
                    const { error: albumError } = await supabase
                        .from('albums')
                        .upsert({ 
                            name: albumName, 
                            description: albumDesc 
                        }, { onConflict: 'name' }); 
                    if (albumError) console.error("ç›¸ç°¿ä¿¡æ¯æ›´æ–°å¤±è´¥", albumError);
                }

                let successCount = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    statusText.innerText = `å¤„ç†ä¸­ (${i + 1}/${files.length}): ${file.name}`;
                    
                    const takenAt = await getTakenDate(file);
                    const fileExt = file.name.split('.').pop();
                    const safeFileName = `${Date.now()}_${Math.floor(Math.random() * 1000)}.${fileExt}`;

                    const { error: uploadError } = await supabase.storage.from('photos').upload(safeFileName, file);
                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(safeFileName);
                    const originalTitle = file.name.replace(/\.[^/.]+$/, "");
                    
                    const { error: dbError } = await supabase.from('photos').insert({
                        title: originalTitle,
                        url: publicUrl,
                        album: albumName,
                        description: photoDesc,
                        taken_at: takenAt
                    });

                    if (dbError) throw dbError;
                    successCount++;
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                }

                statusText.innerText = `ğŸ‰ å®Œæˆï¼`;
                setTimeout(() => { window.location.href = '/'; }, 1000);

            } catch (err) {
                console.error(err);
                alert(`å‡ºé”™å•¦: ${err.message}`);
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50');
            }
        });
    </script>
</body>
</html>