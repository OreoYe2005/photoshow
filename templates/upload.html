<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— é™åˆ¶ä¸Šä¼ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-neutral-900 text-white flex items-center justify-center min-h-screen">

    <div class="bg-neutral-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h1 class="text-2xl font-bold mb-6 text-center text-green-400">âš¡ï¸ æé€Ÿç›´ä¼ æ¨¡å¼</h1>
        
        <form id="uploadForm" class="space-y-4">
            
            <div>
                <label class="block mb-2 text-sm text-neutral-400">é€‰æ‹©ç…§ç‰‡ (æ”¯æŒå¤§æ–‡ä»¶)</label>
                <input type="file" id="fileInput" accept="image/*" multiple required
                    class="block w-full text-sm text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-500">
            </div>

            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç›¸ç°¿åç§°</label>
                <input type="text" id="albumInput" placeholder="ä¾‹å¦‚ï¼šé£å…‰" required
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500">
            </div>

            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="passwordInput" placeholder="éªŒè¯èº«ä»½" required
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500">
            </div>

            <div id="statusArea" class="hidden">
                <div class="w-full bg-neutral-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="statusText" class="text-xs text-center mt-2 text-neutral-400">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-500 transition-colors">
                å¼€å§‹ä¸Šä¼  ğŸš€
            </button>
        </form>
        
        <div class="mt-4 text-center">
             <a href="/" class="text-neutral-500 text-sm hover:text-white">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        // 2. åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ (ä½¿ç”¨åç«¯ä¼ è¿‡æ¥çš„å˜é‡)
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const statusArea = document.getElementById('statusArea');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const submitBtn = document.getElementById('submitBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤ï¼Œæ”¹ç”¨æˆ‘ä»¬è‡ªå·±çš„ JS ä»£ç 

            // ç®€å•å¯†ç éªŒè¯
            const password = document.getElementById('passwordInput').value;
            if (password !== "oreo2025") {
                alert("å¯†ç é”™è¯¯ï¼");
                return;
            }

            const files = fileInput.files;
            const album = document.getElementById('albumInput').value || "æœªåˆ†ç±»";

            if (files.length === 0) return;

            //ä»¥æ­¤ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            statusArea.classList.remove('hidden');

            let successCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // æ›´æ–°è¿›åº¦æ–‡å­—
                statusText.innerText = `æ­£åœ¨ä¸Šä¼  (${i + 1}/${files.length}): ${file.name}`;
                
                try {
                    // A. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å (æ—¶é—´æˆ³_æ–‡ä»¶å)
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å¤„ç†ä¸­æ–‡æ–‡ä»¶åï¼Œæœ€å¥½è½¬ç ä¸€ä¸‹ï¼Œä¸è¿‡ Supabase æ¯”è¾ƒå¼ºï¼Œç›´æ¥ä¼ é€šå¸¸ä¹Ÿå¯ä»¥
                    const fileName = `${Date.now()}_${file.name}`;

                    // B. ç›´ä¼ åˆ° Storage (ç»•è¿‡åç«¯ï¼)
                    const { data: uploadData, error: uploadError } = await supabase
                        .storage
                        .from('photos')
                        .upload(fileName, file);

                    if (uploadError) throw uploadError;

                    // C. è·å–å…¬å¼€é“¾æ¥
                    const { data: { publicUrl } } = supabase
                        .storage
                        .from('photos')
                        .getPublicUrl(fileName);

                    // D. å†™å…¥æ•°æ®åº“
                    const { error: dbError } = await supabase
                        .from('photos')
                        .insert({
                            title: file.name.split('.')[0],
                            url: publicUrl,
                            album: album
                        });

                    if (dbError) throw dbError;

                    successCount++;
                    // æ›´æ–°è¿›åº¦æ¡
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

                } catch (err) {
                    console.error('Upload failed:', err);
                    alert(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥: ${err.message}`);
                }
            }

            statusText.innerText = `ğŸ‰ å…¨éƒ¨å®Œæˆï¼æˆåŠŸä¸Šä¼  ${successCount} å¼ `;
            setTimeout(() => {
                window.location.href = '/'; // è·³è½¬å›é¦–é¡µ
            }, 1000);
        });
    </script>
</body>
</html>