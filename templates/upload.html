<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ ä½œå“ | OREO</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { lightBg: '#f8fafc' } } }
        }
    </script>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body { font-family: sans-serif; }
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes { 0% { background-position: 1rem 0; } 100% { background-position: 0 0; } }
        
        /* é®ç½©å±‚ï¼šé˜²æ­¢é¡µé¢è¿˜æ²¡åŠ è½½å®Œå°±æ˜¾ç¤ºå†…å®¹ */
        #page-loader {
            position: fixed; inset: 0; background: inherit; z-index: 100;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-neutral-900 flex items-center justify-center min-h-screen transition-colors duration-300 p-4">

    <div id="server-config" data-url="{{ supabase_url }}" data-key="{{ supabase_key }}" style="display:none;"></div>

    <div id="page-loader" class="bg-slate-50 dark:bg-neutral-900">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-green-600"></div>
        <p class="mt-4 text-sm text-gray-500">æ­£åœ¨éªŒè¯æƒé™...</p>
    </div>

    <div id="main-content" class="hidden bg-white dark:bg-neutral-800 p-8 rounded-2xl shadow-xl w-full max-w-lg border border-gray-100 dark:border-neutral-700">
        
        <h1 class="text-3xl font-bold mb-8 text-center text-transparent bg-clip-text bg-gradient-to-r from-green-600 to-blue-600 dark:from-green-400 dark:to-blue-500">
            ä¸Šä¼ æ–°ä½œå“
        </h1>
        
        <div class="space-y-6">
            
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">é€‰æ‹©ç…§ç‰‡</label>
                <div class="relative group">
                    <input type="file" id="fileInput" accept="image/*" multiple class="hidden" onchange="updateFileLabel(this)">
                    <label for="fileInput" class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 dark:border-neutral-600 rounded-xl cursor-pointer bg-slate-50 dark:bg-neutral-800/50 hover:bg-green-50 dark:hover:bg-neutral-700 hover:border-green-400 dark:hover:border-green-500 transition-all duration-300 group-hover:scale-[1.01]">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-500 dark:text-gray-400 group-hover:text-green-600 dark:group-hover:text-green-400 transition-colors">
                            <svg class="w-10 h-10 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <p class="mb-1 text-sm font-bold"><span class="underline">ç‚¹å‡»é€‰æ‹©</span> æˆ–æ‹–æ‹½ç…§ç‰‡åˆ°è¿™é‡Œ</p>
                            <p class="text-xs opacity-70">æ”¯æŒ JPG, PNG (å¯å¤šé€‰)</p>
                        </div>
                    </label>
                </div>
                <div id="fileStatus" class="mt-2 text-sm text-center font-medium text-green-600 dark:text-green-400 hidden animate-pulse"></div>
            </div>

            <div class="p-5 bg-slate-50 dark:bg-neutral-700/50 rounded-xl border border-slate-200 dark:border-neutral-600 space-y-4">
                <h2 class="text-xs font-bold text-green-600 dark:text-green-400 uppercase tracking-wider flex items-center gap-2">ğŸ“‚ ç›¸ç°¿è®¾ç½®</h2>
                <div>
                    <label class="block mb-1 text-xs font-medium text-gray-500 dark:text-gray-400">ç›¸ç°¿åç§°</label>
                    <input type="text" id="albumInput" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬æ—…è¡Œ" class="w-full px-4 py-2.5 bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500/50 focus:border-green-500 outline-none dark:text-white">
                </div>
                <div>
                    <label class="block mb-1 text-xs font-medium text-gray-500 dark:text-gray-400">ç›¸ç°¿ç®€ä»‹</label>
                    <textarea id="albumDescInput" rows="2" placeholder="å…³äºè¿™ä¸ªç›¸ç°¿..." class="w-full px-4 py-2.5 bg-white dark:bg-neutral-800 border border-gray-300 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500/50 focus:border-green-500 outline-none dark:text-white resize-none"></textarea>
                </div>
            </div>
            
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">ç…§ç‰‡æè¿°</label>
                <textarea id="descInput" rows="2" placeholder="è®°å½•ä¸‹æ­¤åˆ»çš„å¿ƒæƒ…..." class="w-full px-4 py-2.5 bg-slate-50 dark:bg-neutral-900 border border-gray-300 dark:border-neutral-600 rounded-lg focus:ring-2 focus:ring-green-500/50 focus:border-green-500 outline-none dark:text-white resize-none"></textarea>
            </div>

            <div id="statusArea" class="hidden bg-slate-100 dark:bg-neutral-700 p-4 rounded-xl">
                <div class="w-full bg-gray-200 dark:bg-neutral-600 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-green-500 h-3 rounded-full transition-all duration-300 progress-bar-striped" style="width: 0%"></div>
                </div>
                <p id="statusText" class="text-xs text-center mt-2 font-medium text-gray-500 dark:text-gray-400">å‡†å¤‡å°±ç»ª...</p>
            </div>

            <button type="button" id="submitBtn" onclick="handleUpload()" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl transition-all hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed">
                å¼€å§‹ä¸Šä¼  ğŸš€
            </button>
        </div>
        
        <div class="mt-6 text-center">
             <a href="/" class="text-sm font-medium text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        const configDiv = document.getElementById('server-config');
        const supabaseUrl = configDiv.getAttribute('data-url');
        const supabaseKey = configDiv.getAttribute('data-key');
        const ADMIN_EMAIL = "admin@oreo.com"; 

        function updateFileLabel(input) {
            const statusDiv = document.getElementById('fileStatus');
            if (input.files && input.files.length > 0) {
                statusDiv.classList.remove('hidden');
                statusDiv.innerText = `âœ… å·²é€‰æ‹© ${input.files.length} å¼ ç…§ç‰‡`;
            } else { statusDiv.classList.add('hidden'); }
        }

        async function init() {
            // 1. ç­‰å¾…åº“åŠ è½½
            if (!window.supabase) { setTimeout(init, 500); return; }
            
            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            
            // ğŸŸ¢ 2. æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ getSession æ›¿ä»£ getUser
            // getSession æ˜¯åŒæ­¥/æœ¬åœ°çš„ï¼Œé€Ÿåº¦æå¿«ï¼Œä¸ä¼šå› ä¸ºç½‘ç»œå»¶è¿ŸæŠ¥é”™
            const { data: { session } } = await supabase.auth.getSession();
            
            const loader = document.getElementById('page-loader');
            const mainContent = document.getElementById('main-content');

            if (!session) {
                alert("â›” è¯·å…ˆç™»å½•"); 
                window.location.href = "/login";
                return;
            }

            // 3. æ£€æŸ¥é‚®ç®± (æœ¬åœ°æ£€æŸ¥ï¼Œä¸ç”¨å»æœåŠ¡å™¨)
            const email = session.user.email;
            if (!email || email.toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
                alert("â›” æ‚¨æ²¡æœ‰æƒé™ (å½“å‰ç™»å½•: " + email + ")");
                window.location.href = "/";
                return;
            }

            // 4. éªŒè¯é€šè¿‡ï¼Œç§»é™¤é®ç½©ï¼Œæ˜¾ç¤ºå†…å®¹
            loader.style.display = 'none';
            mainContent.classList.remove('hidden');
        }
        init();

        function getTakenDate(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const d = EXIF.getTag(this, "DateTimeOriginal");
                    resolve(d ? d.split(" ")[0].replace(/:/g, "-") + " " + d.split(" ")[1] : new Date().toISOString());
                });
            });
        }
        
        async function handleUpload() {
            const files = document.getElementById('fileInput').files;
            const albumName = document.getElementById('albumInput').value;
            const albumDesc = document.getElementById('albumDescInput').value;
            const photoDesc = document.getElementById('descInput').value;
            const submitBtn = document.getElementById('submitBtn');
            const statusArea = document.getElementById('statusArea');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');

            if (files.length === 0) return alert("è¯·å…ˆé€‰æ‹©ç…§ç‰‡");
            if (!albumName) return alert("è¯·å¡«å†™ç›¸ç°¿åç§°");

            const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

            submitBtn.disabled = true;
            statusArea.classList.remove('hidden');
            progressBar.style.width = "5%";

            try {
                if (albumDesc) {
                    statusText.innerText = "æ­£åœ¨åˆ›å»ºç›¸ç°¿...";
                    await supabase.from('albums').upsert({ name: albumName, description: albumDesc }, { onConflict: 'name' });
                }

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    statusText.innerText = `æ­£åœ¨ä¸Šä¼  (${i + 1}/${files.length}): ${file.name}`;
                    progressBar.style.width = `${((i + 0.5) / files.length) * 100}%`;

                    const takenAt = await getTakenDate(file);
                    const safeName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${file.name.split('.').pop()}`;
                    
                    const { error: upErr } = await supabase.storage.from('photos').upload(safeName, file);
                    if (upErr) throw upErr;

                    const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(safeName);
                    
                    await supabase.from('photos').insert({
                        title: file.name.replace(/\.[^/.]+$/, ""),
                        url: publicUrl, album: albumName, description: photoDesc, taken_at: takenAt
                    });
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                }

                statusText.innerText = "ğŸ‰ ä¸Šä¼ å®Œæˆï¼";
                progressBar.classList.remove('progress-bar-striped');
                setTimeout(() => { window.location.href = '/'; }, 1000);

            } catch (err) {
                alert("å‡ºé”™: " + err.message);
                submitBtn.disabled = false;
                statusArea.classList.add('hidden');
            }
        }
    </script>
</body>
</html>