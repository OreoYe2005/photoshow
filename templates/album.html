<!DOCTYPE html>
<html lang="zh-CN" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ album_name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>try{tailwind.config={darkMode:'class',theme:{extend:{colors:{lightBg:'#f8fafc'}}}}}catch(e){}</script>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) { document.documentElement.classList.remove('dark'); localStorage.theme = 'light'; }
            else { document.documentElement.classList.add('dark'); localStorage.theme = 'dark'; }
        }
    </script>
    
    <style>
        body { margin: 0; font-family: sans-serif; background: #f8fafc; color: #171717; }
        .dark body { background: #171717; color: white; }
        img { max-width: 100%; height: auto; display: block; }
        
        .nav-bar { position: fixed; top: 0; width: 100%; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 50; padding: 1rem; border-bottom: 1px solid #e5e5e5; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .dark .nav-bar { background: rgba(23,23,23,0.8); border-color: #262626; }
        
        /* ç€‘å¸ƒæµå…œåº• */
        .masonry-fallback { column-count: 1; column-gap: 1.5rem; }
        @media (min-width: 768px) { .masonry-fallback { column-count: 2; } }
        @media (min-width: 1024px) { .masonry-fallback { column-count: 3; } }
        
        .photo-card { break-inside: avoid; margin-bottom: 1.5rem; background: white; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: relative; }
        .dark .photo-card { background: #262626; }
    </style>
</head>
<body class="bg-lightBg text-neutral-900 dark:bg-neutral-900 dark:text-white">

    <button onclick="toggleTheme()" class="fixed top-20 right-6 z-50 p-2 rounded-full bg-white/80 dark:bg-neutral-800/80 shadow-lg border border-neutral-200 dark:border-neutral-700">ğŸŒ—</button>

    <nav class="nav-bar">
        <a href="/" class="font-bold hover:text-green-600">â† è¿”å›é¦–é¡µ</a>
        <span class="font-bold text-lg">{{ album_name }}</span>
        <div id="navUserArea"></div>
    </nav>

    <header class="pt-32 pb-10 px-4 text-center max-w-2xl mx-auto">
        <h1 class="text-4xl font-bold mb-4">{{ album_name }}</h1>
        <p class="text-neutral-500 dark:text-neutral-400">{{ album_desc }}</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 pb-20">
        {% if grouped_photos|length == 0 %}
            <div class="text-center text-neutral-500 mt-20">æš‚æ— ç…§ç‰‡</div>
        {% else %}
            {% for group in grouped_photos %}
                <h2 class="text-xl font-bold mt-12 mb-6 text-green-600 border-b pb-2">{{ group.date }}</h2>
                
                <div class="masonry-fallback columns-1 md:columns-2 lg:columns-3 gap-6">
                    {% for photo in group.photos %}
                    <div class="photo-card group">
                        <img src="{{ photo.src }}" loading="lazy">
                        
                        <button onclick="deletePhoto('{{ photo.id }}')" class="admin-only hidden absolute top-2 right-2 bg-red-600 text-white p-1 rounded shadow">ğŸ—‘</button>

                        <div class="p-3 flex justify-between">
                            <p class="text-sm text-neutral-600 dark:text-neutral-300">{{ photo.description }}</p>
                            <button onclick="toggleLike('{{ photo.id }}', this)" class="flex items-center gap-1">
                                <span class="heart-icon text-neutral-400">â¤</span>
                                <span class="like-count text-xs">{{ photo.likes }}</span>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% endfor %}
        {% endif %}
    </main>

    <script src="https://cdn.staticfile.org/supabase-js/2.39.3/supabase.min.js"></script>
    <script>
        const supabase = window.supabase.createClient("{{ supabase_url }}", "{{ supabase_key }}");
        const ADMIN_EMAIL = "admin@oreo.com"; 
        let currentUser = null;

        async function init() {
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (user && user.email === ADMIN_EMAIL) document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
        }

        async function toggleLike(pid, btn) {
            if (!currentUser) return alert("è¯·å…ˆç™»å½•");
            const icon = btn.querySelector('.heart-icon');
            const count = btn.querySelector('.like-count');
            // ç®€å•æ¨¡æ‹Ÿ
            icon.style.color = 'red';
            count.innerText = parseInt(count.innerText) + 1;
            await supabase.from('likes').insert({ user_id: currentUser.id, photo_id: pid });
        }

        async function deletePhoto(pid) {
            if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
                await supabase.from('photos').delete().eq('id', pid);
                window.location.reload();
            }
        }
        init();
    </script>
</body>
</html>