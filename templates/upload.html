<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ ä½œå“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body class="bg-neutral-900 text-white flex items-center justify-center min-h-screen">

    <div class="bg-neutral-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h1 class="text-2xl font-bold mb-6 text-center text-green-400">ä¸Šä¼ æ–°ä½œå“</h1>
        
        <form id="uploadForm" class="space-y-4">
            <div>
                <label class="block mb-2 text-sm text-neutral-400">é€‰æ‹©ç…§ç‰‡</label>
                <input type="file" id="fileInput" accept="image/*" multiple required
                    class="block w-full text-sm text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-500">
            </div>

            <div class="p-4 bg-neutral-700/50 rounded-lg border border-neutral-600">
                <p class="text-xs text-green-400 mb-3 font-bold uppercase tracking-wider">ğŸ“‚ ç›¸ç°¿è®¾ç½®</p>
                
                <div class="mb-3">
                    <label class="block mb-1 text-xs text-neutral-400">ç›¸ç°¿åç§°</label>
                    <input type="text" id="albumInput" placeholder="ä¾‹å¦‚ï¼šé£å…‰" required
                        class="w-full px-3 py-2 bg-neutral-800 border border-neutral-600 rounded text-sm focus:outline-none focus:border-green-500">
                </div>
                
                <div>
                    <label class="block mb-1 text-xs text-neutral-400">ç›¸ç°¿ç®€ä»‹ (å¦‚æœæ˜¯æ–°å»ºç›¸ç°¿ï¼Œè¯·å¡«å†™)</label>
                    <textarea id="albumDescInput" rows="2" placeholder="è¿™ä¸ªç›¸ç°¿æ˜¯å…³äº..." 
                        class="w-full px-3 py-2 bg-neutral-800 border border-neutral-600 rounded text-sm focus:outline-none focus:border-green-500"></textarea>
                </div>
            </div>
            
            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç…§ç‰‡æè¿° (æ¯å¼ ç…§ç‰‡éƒ½ä¼šç”¨è¿™ä¸ª)</label>
                <textarea id="descInput" rows="2" placeholder="æ‹æ‘„äº..." 
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500"></textarea>
            </div>

            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="passwordInput" required
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500">
            </div>

            <div id="statusArea" class="hidden">
                <div class="w-full bg-neutral-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="statusText" class="text-xs text-center mt-2 text-neutral-400">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-500 transition-colors">
                å¼€å§‹ä¸Šä¼  ğŸš€
            </button>
        </form>
        
        <div class="mt-4 text-center">
             <a href="/" class="text-neutral-500 text-sm hover:text-white">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('uploadForm');

        function getTakenDate(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                    if (exifDate) {
                        const str = exifDate.split(" ")[0].replace(/:/g, "-") + " " + exifDate.split(" ")[1];
                        resolve(str);
                    } else {
                        resolve(new Date().toISOString()); 
                    }
                });
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            if (password !== "oreo2025") { alert("å¯†ç é”™è¯¯ï¼"); return; }

            const files = document.getElementById('fileInput').files;
            const albumName = document.getElementById('albumInput').value || "æœªåˆ†ç±»";
            const albumDesc = document.getElementById('albumDescInput').value; // è·å–ç›¸ç°¿ç®€ä»‹
            const photoDesc = document.getElementById('descInput').value || "";

            if (files.length === 0) return;

            const submitBtn = document.getElementById('submitBtn');
            const statusArea = document.getElementById('statusArea');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');

            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            statusArea.classList.remove('hidden');

            try {
                // ğŸŸ¢ å…³é”®æ­¥éª¤ï¼šå¦‚æœæœ‰å¡«å†™ç›¸ç°¿ç®€ä»‹ï¼Œå…ˆæ›´æ–° albums è¡¨
                // æˆ‘ä»¬ä½¿ç”¨ upsert (æ’å…¥æˆ–æ›´æ–°)ï¼Œè¿™æ ·å¦‚æœç›¸ç°¿å·²å­˜åœ¨ï¼Œå°±æ›´æ–°å®ƒçš„ç®€ä»‹
                if (albumDesc) {
                    statusText.innerText = `æ­£åœ¨æ›´æ–°ç›¸ç°¿ä¿¡æ¯...`;
                    
                    // å…ˆæŸ¥è¯¢è¿™ä¸ªç›¸ç°¿æ˜¯å¦å­˜åœ¨ï¼Œä¸ºäº†è·å– ID (æˆ–è€…åˆ©ç”¨ name ä½œä¸ºå”¯ä¸€é”®)
                    // è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ Supabase çš„ upsert åŠŸèƒ½ï¼Œä¾èµ– name åˆ—çš„ unique å±æ€§
                    const { error: albumError } = await supabase
                        .from('albums')
                        .upsert({ 
                            name: albumName, 
                            description: albumDesc 
                        }, { onConflict: 'name' }); // é‡åˆ°åŒåå°±æ›´æ–°

                    if (albumError) {
                        console.error("ç›¸ç°¿ä¿¡æ¯æ›´æ–°å¤±è´¥", albumError);
                        // å³ä½¿ç›¸ç°¿ç®€ä»‹å¤±è´¥ï¼Œä¹Ÿå¯ä»¥ç»§ç»­ä¼ ç…§ç‰‡ï¼Œä¸é˜»å¡æµç¨‹
                    }
                }

                // ä¸‹é¢æ˜¯æ­£å¸¸çš„ç…§ç‰‡ä¸Šä¼ æµç¨‹
                let successCount = 0;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    statusText.innerText = `å¤„ç†ä¸­ (${i + 1}/${files.length}): ${file.name}`;
                    
                    const takenAt = await getTakenDate(file);
                    const fileExt = file.name.split('.').pop();
                    const safeFileName = `${Date.now()}_${Math.floor(Math.random() * 1000)}.${fileExt}`;

                    const { error: uploadError } = await supabase.storage.from('photos').upload(safeFileName, file);
                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(safeFileName);
                    const originalTitle = file.name.replace(/\.[^/.]+$/, "");
                    
                    const { error: dbError } = await supabase.from('photos').insert({
                        title: originalTitle,
                        url: publicUrl,
                        album: albumName,
                        description: photoDesc,
                        taken_at: takenAt
                    });

                    if (dbError) throw dbError;
                    successCount++;
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;
                }

                statusText.innerText = `ğŸ‰ å®Œæˆï¼`;
                setTimeout(() => { window.location.href = '/'; }, 1000);

            } catch (err) {
                console.error(err);
                alert(`å‡ºé”™å•¦: ${err.message}`);
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50');
            }
        });
    </script>
</body>
</html>