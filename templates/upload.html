<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ ä½œå“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</head>
<body class="bg-neutral-900 text-white flex items-center justify-center min-h-screen">

    <div class="bg-neutral-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
        <h1 class="text-2xl font-bold mb-6 text-center text-green-400">ä¸Šä¼ æ–°ä½œå“ (è‡ªåŠ¨è¯†åˆ«æ—¶é—´)</h1>
        
        <form id="uploadForm" class="space-y-4">
            <div>
                <label class="block mb-2 text-sm text-neutral-400">é€‰æ‹©ç…§ç‰‡</label>
                <input type="file" id="fileInput" accept="image/*" multiple required
                    class="block w-full text-sm text-neutral-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-500">
            </div>

            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç›¸ç°¿åç§°</label>
                <input type="text" id="albumInput" placeholder="ä¾‹å¦‚ï¼šé£å…‰" required
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500">
            </div>
            
            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç…§ç‰‡æè¿°</label>
                <textarea id="descInput" rows="2" placeholder="å†™ç‚¹ä»€ä¹ˆ..." 
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500"></textarea>
            </div>

            <div>
                <label class="block mb-2 text-sm text-neutral-400">ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="passwordInput" required
                    class="w-full px-4 py-2 bg-neutral-700 border border-neutral-600 rounded focus:outline-none focus:border-green-500">
            </div>

            <div id="statusArea" class="hidden">
                <div class="w-full bg-neutral-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="statusText" class="text-xs text-center mt-2 text-neutral-400">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-500 transition-colors">
                å¼€å§‹ä¸Šä¼  ğŸš€
            </button>
        </form>
        
        <div class="mt-4 text-center">
             <a href="/" class="text-neutral-500 text-sm hover:text-white">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>

    <script>
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('uploadForm');

        // ğŸŸ¢ è¾…åŠ©å‡½æ•°ï¼šè¯»å–ç…§ç‰‡æ‹æ‘„æ—¶é—´
        function getTakenDate(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    // è¯»å– EXIF é‡Œçš„ DateTimeOriginal å­—æ®µ
                    const exifDate = EXIF.getTag(this, "DateTimeOriginal");
                    if (exifDate) {
                        // EXIF æ ¼å¼é€šå¸¸æ˜¯ "2023:12:09 10:00:00"ï¼Œè¦è½¬æˆæ•°æ®åº“èƒ½è®¤çš„æ ¼å¼
                        // å°†å†’å·æ›¿æ¢æˆæ¨ªæ 
                        const str = exifDate.split(" ")[0].replace(/:/g, "-") + " " + exifDate.split(" ")[1];
                        resolve(str);
                    } else {
                        // å¦‚æœè¯»ä¸åˆ° (æ¯”å¦‚æ˜¯æˆªå›¾)ï¼Œå°±è¿”å› nullï¼Œæ•°æ®åº“ä¼šç”¨ä¸Šä¼ æ—¶é—´å…œåº•
                        resolve(new Date().toISOString()); 
                    }
                });
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            if (password !== "oreo2025") { alert("å¯†ç é”™è¯¯ï¼"); return; }

            const files = document.getElementById('fileInput').files;
            const album = document.getElementById('albumInput').value || "æœªåˆ†ç±»";
            const description = document.getElementById('descInput').value || "";

            if (files.length === 0) return;

            const submitBtn = document.getElementById('submitBtn');
            const statusArea = document.getElementById('statusArea');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');

            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            statusArea.classList.remove('hidden');

            let successCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                statusText.innerText = `å¤„ç†ä¸­ (${i + 1}/${files.length}): ${file.name}`;
                
                try {
                    // ğŸŸ¢ 1. å…ˆå°è¯•è¯»å–æ‹æ‘„æ—¶é—´
                    const takenAt = await getTakenDate(file);
                    
                    const fileName = `${Date.now()}_${file.name}`;

                    // 2. ä¼ æ–‡ä»¶
                    const { error: uploadError } = await supabase.storage.from('photos').upload(fileName, file);
                    if (uploadError) throw uploadError;

                    // 3. è·å–é“¾æ¥
                    const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(fileName);

                    // 4. å†™å…¥æ•°æ®åº“ (å¸¦ä¸Š taken_at)
                    const { error: dbError } = await supabase.from('photos').insert({
                        title: file.name.split('.')[0],
                        url: publicUrl,
                        album: album,
                        description: description,
                        taken_at: takenAt // å­˜å…¥æ–°æ ¼å­ï¼
                    });

                    if (dbError) throw dbError;
                    successCount++;
                    progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

                } catch (err) {
                    console.error(err);
                    alert(`ä¸Šä¼ å¤±è´¥: ${err.message}`);
                }
            }

            statusText.innerText = `ğŸ‰ å®Œæˆï¼`;
            setTimeout(() => { window.location.href = '/'; }, 1000);
        });
    </script>
</body>
</html>