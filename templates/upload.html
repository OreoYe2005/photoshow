<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šä¼ ä½œå“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.staticfile.org/supabase-js/2.39.3/supabase.min.js"></script>
    <script src="https://cdn.staticfile.org/exif-js/2.3.0/exif.min.js"></script>
    <script>try{tailwind.config={darkMode:'class',theme:{extend:{colors:{lightBg:'#f8fafc'}}}}}catch(e){}</script>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
    </script>
    
    <style>
        body { margin: 0; font-family: sans-serif; background: #f8fafc; color: #171717; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .dark body { background: #171717; color: white; }
        
        .upload-card {
            background: white; width: 100%; max-width: 480px; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .dark .upload-card { background: #262626; }
        
        input, textarea, select {
            width: 100%; padding: 0.5rem 1rem; margin-top: 0.25rem; border-radius: 0.5rem; border: 1px solid #d4d4d4; background: white; box-sizing: border-box;
        }
        .dark input, .dark textarea { background: #404040; border-color: #525252; color: white; }
        
        button { width: 100%; padding: 0.75rem; background: #16a34a; color: white; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer; margin-top: 1rem; }
        button:hover { background: #15803d; }
    </style>
</head>
<body class="bg-lightBg dark:bg-neutral-900">
    <div class="upload-card bg-white dark:bg-neutral-800">
        <h1 class="text-2xl font-bold mb-6 text-center text-green-600">ä¸Šä¼ æ–°ä½œå“</h1>
        <form id="uploadForm" class="space-y-4">
            <div>
                <label class="block mb-2 text-sm text-neutral-500">é€‰æ‹©ç…§ç‰‡</label>
                <input type="file" id="fileInput" accept="image/*" multiple required class="block w-full text-sm">
            </div>
            <div class="p-4 bg-neutral-50 dark:bg-neutral-700/50 rounded-lg border border-neutral-200 dark:border-neutral-600">
                <p class="text-xs text-green-600 font-bold mb-3">ğŸ“‚ ç›¸ç°¿è®¾ç½®</p>
                <div class="mb-3">
                    <label class="block mb-1 text-xs">ç›¸ç°¿åç§°</label>
                    <input type="text" id="albumInput" placeholder="ä¾‹å¦‚ï¼šé£å…‰" required>
                </div>
                <div>
                    <label class="block mb-1 text-xs">ç›¸ç°¿ç®€ä»‹</label>
                    <textarea id="albumDescInput" rows="2" placeholder="ç®€ä»‹..."></textarea>
                </div>
            </div>
            <div>
                <label class="block mb-2 text-sm">ç…§ç‰‡æè¿°</label>
                <textarea id="descInput" rows="2" placeholder="æ‹æ‘„äº..."></textarea>
            </div>
            <div id="statusArea" class="hidden mt-4">
                <div class="w-full bg-neutral-200 h-2.5 rounded-full"><div id="progressBar" class="bg-green-600 h-2.5 rounded-full" style="width:0%"></div></div>
                <p id="statusText" class="text-xs text-center mt-2">å‡†å¤‡ä¸Šä¼ ...</p>
            </div>
            <button type="submit" id="submitBtn">å¼€å§‹ä¸Šä¼  ğŸš€</button>
        </form>
        <div class="mt-4 text-center"><a href="/" class="text-sm text-neutral-500">â† è¿”å›é¦–é¡µ</a></div>
    </div>

    <script>
        const supabaseUrl = "{{ supabase_url }}";
        const supabaseKey = "{{ supabase_key }}";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        DMIN_EMAIL = "ylltz2005@163.com"; 

        async function checkAuth() {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user || user.email !== ADMIN_EMAIL) { alert("æ— æƒé™"); window.location.href = "/"; }
        }
        checkAuth();

        const form = document.getElementById('uploadForm');
        function getTakenDate(file) {
            return new Promise((resolve) => {
                EXIF.getData(file, function() {
                    const d = EXIF.getTag(this, "DateTimeOriginal");
                    resolve(d ? d.split(" ")[0].replace(/:/g, "-") + " " + d.split(" ")[1] : new Date().toISOString());
                });
            });
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = document.getElementById('fileInput').files;
            const albumName = document.getElementById('albumInput').value || "æœªåˆ†ç±»";
            const albumDesc = document.getElementById('albumDescInput').value;
            const photoDesc = document.getElementById('descInput').value;
            const submitBtn = document.getElementById('submitBtn');
            const statusArea = document.getElementById('statusArea');
            
            submitBtn.disabled = true; statusArea.classList.remove('hidden');

            try {
                if (albumDesc) await supabase.from('albums').upsert({ name: albumName, description: albumDesc }, { onConflict: 'name' });
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    document.getElementById('statusText').innerText = `ä¸Šä¼ ä¸­ ${i+1}/${files.length}`;
                    const takenAt = await getTakenDate(file);
                    const safeName = `${Date.now()}_${Math.random().toString(36).substr(2,9)}.${file.name.split('.').pop()}`;
                    await supabase.storage.from('photos').upload(safeName, file);
                    const { data: { publicUrl } } = supabase.storage.from('photos').getPublicUrl(safeName);
                    await supabase.from('photos').insert({
                        title: file.name.replace(/\.[^/.]+$/, ""), url: publicUrl, album: albumName, description: photoDesc, taken_at: takenAt
                    });
                    document.getElementById('progressBar').style.width = `${((i+1)/files.length)*100}%`;
                }
                setTimeout(() => { window.location.href = '/'; }, 500);
            } catch (err) { alert(err.message); submitBtn.disabled = false; }
        });
    </script>
</body>
</html>